<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trip Pack Planner</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#a9b4d0; --line:#263259;
      --accent:#6ea8ff; --ok:#2ecc71; --warn:#f5a623; --err:#ff5c5c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg); color:#e9eef5; -webkit-font-smoothing:antialiased;
      display:grid; place-items:start center; padding:24px;
    }
    .app{width:min(1000px,95vw)}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 6px 0; letter-spacing:.2px}
    p.muted{margin:0 0 14px 0; color:var(--muted)}
    .row {
      display: flex;
      flex-wrap: nowrap;          
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    input[type="text"]{
      flex:1 1 320px; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:#0f162c; color:#e9eef5; outline:none;
    }
    input::placeholder{color:#8ea0c9}
    button{
      padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:#0f162c; color:#e9eef5; cursor:pointer; transition:.15s transform;
    }
    button:hover{transform:translateY(-1px)}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#0f162c;
      font-size:.92rem; margin-right:6px; margin-top:8px;
    }
    .badge.ok{border-color:rgba(46,204,113,.35)}
    .badge.warn{border-color:rgba(245,166,35,.45)}
    .badge.err{border-color:rgba(255,92,92,.45)}
    .section{margin-top:16px}
    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left}
    th{color:#bfc9e6; font-weight:600}
    .list{margin:8px 0 0 0; padding-left:16px}
    .chip{display:inline-block; padding:6px 10px; border-radius:999px; background:#0f162c; border:1px solid var(--line); margin:6px 6px 0 0; cursor:pointer}
    .divider{height:1px; background:var(--line); margin:16px 0}
    .errorBox{border:1px solid rgba(255,92,92,.35); background:rgba(255,92,92,.08); padding:12px 14px; border-radius:12px; margin-top:12px}
    .spinner{display:inline-block; width:16px; height:16px; border:2px solid #2a3a6b; border-top-color:var(--accent); border-radius:50%; animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{margin-top:16px; color:var(--muted); font-size:.92rem}
    .aqi.good{color:#0fd27a} .aqi.moderate{color:#f5a623} .aqi.unhealthy{color:#ff5c5c}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr} }

    .autocomplete{
      position: relative;
      display: block;         /* don't change flex math */
      width: 100%;            /* fill the flex slot */
    }
    .autocomplete input{
      display: block;
      width: 100%;
    }

    /* The dropdown should float over content, not push it down */
    .suggestions{
      position: absolute;
      left: 0; right: 0;
      top: calc(100% + 6px);  /* gap below the input */
      background: #0f162c;
      border: 1px solid var(--line);
      border-radius: 12px;
      max-height: 230px;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      z-index: 1000;          /* ensure it overlaps the card */
    }

    .suggestion{
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .suggestion:last-child{ border-bottom: none; }
    .suggestion:hover, .suggestion.active{ background:#182245; }
    .suggestion small{ color: var(--muted); }

  </style>

</head>
<body>
<div id="app" class="app">

  <!-- TOP BAR (new) -->
  <div class="card" style="margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div style="display:flex; align-items:center; gap:10px;">
      <div style="font-weight:700;">üå§Ô∏è Trip Pack Planner</div>
      <span v-if="view==='dashboard' && weather" class="badge">üìç {{ weather.city }}, {{ weather.country }}</span>
    </div>
    <div style="display:flex; gap:8px;">
      <button v-if="view==='dashboard'" @click="goHome">üè† Home</button>
    </div>
  </div>

  <!-- HOME SCREEN (new) -->
  <div v-if="view==='home'" class="card">
    <h1>Plan the next 3 days</h1>
    <p class="muted">Daily weather + air quality, with simple packing advice.</p>

    <div class="row">
      <div class="autocomplete">
      <input
        ref="cityInput"
        type="text"
        v-model="city"
        placeholder="Enter a city. Ex: Dublin"
        @input="onCityInput"
        @keydown.down.prevent="highlightNext(1)"
        @keydown.up.prevent="highlightNext(-1)"
        @keydown.enter.prevent="confirmSelection"
        @focus="showSuggestions"
        @blur="hideSuggestions"
      />
      <div v-if="showDropdown && suggestions.length" class="suggestions">
        <div
          v-for="(s, i) in suggestions"
          :key="s.label"
          class="suggestion"
          :class="{ active: i === highlighted }"
          @mousedown.prevent="pickCity(s)"
        >
          {{ s.name }} <small>({{ s.country }}{{ s.state ? ', ' + s.state : '' }})</small>
        </div>
      </div>
    </div>
      <button @click="run">Get Forecast</button>
      <span v-if="loading" class="spinner" aria-label="Loading"></span>
    </div>

    <div class="section" v-if="recent?.length">
      <h3>Recently searched</h3>
      <div>
        <span class="chip" v-for="c in recent" :key="c" @click="quick(c)">{{ c }}</span>
      </div>
    </div>

    <div v-if="error" class="errorBox" style="margin-top:12px;">
      <strong>Request failed:</strong> {{ error }}
    </div>

    <div class="divider"></div>
    <footer>Built By- Ayushmaan Kumar Yadav(22300162) </footer>
  </div>

  <!-- DASHBOARD (original UI kept intact)(with added emojis) -->
  <div v-if="view==='dashboard'" class="card">
    <h1>Weather & Air </h1>
    <p class="muted">Enter a city to refresh.</p>

    <div class="row">
      
      <div class="autocomplete">
      <input
        ref="cityInput"
        type="text"
        v-model="city"
        placeholder="Enter a city. Ex: Dublin"
        @input="onCityInput"
        @keydown.down.prevent="highlightNext(1)"
        @keydown.up.prevent="highlightNext(-1)"
        @keydown.enter.prevent="confirmSelection"
        @focus="showSuggestions"
        @blur="hideSuggestions"
      />
      <div v-if="showDropdown && suggestions.length" class="suggestions">
        <div
          v-for="(s, i) in suggestions"
          :key="s.label"
          class="suggestion"
          :class="{ active: i === highlighted }"
          @mousedown.prevent="pickCity(s)"
        >
          {{ s.name }} <small>({{ s.country }}{{ s.state ? ', ' + s.state : '' }})</small>
        </div>
      </div>
    </div>

      <button @click="run">Refresh</button>
      <span v-if="loading" class="spinner" aria-label="Loading"></span>
    </div>

    <div v-if="error" class="errorBox">
      <strong>Request failed:</strong> {{ error }}
      <div style="margin-top:6px"><button @click="run">Retry</button></div>
    </div>

    <template v-if="weather || air">
      <div class="section">
        <span class="badge">üìç {{ weather?.city }}, {{ weather?.country }}</span>
        <span class="badge" :class="weather?.umbrella ? 'warn' : 'ok'">
          {{ weather?.umbrella ? '‚òî Bring an umbrella' : 'No rain expected' }}
        </span>
        <span class="badge">üß≥ Pack for: <strong>&nbsp;{{ weather?.packing }}</strong></span>
        <span class="badge">üå° Mean temp: {{ weather?.mean_temp_c }} ¬∞C</span>
        <span v-if="air" class="badge">
          ü´Å AQI today:
          <strong class="aqi" :class="aqiClass(todayAQI)">&nbsp;{{ aqiLabel(todayAQI) }}</strong>
        </span>
      </div>

      <div class="grid section">
        <!-- Weather table (unchanged) -->
        <div>
          <h3>3-Day Summary</h3>
          <table v-if="weather?.forecast?.length">
            <thead>
              <tr><th>Day</th><th>Avg Temp (¬∞C)</th><th>Max Wind (m/s)</th><th>Rain (mm)</th></tr>
            </thead>
            <tbody>
              <tr v-for="row in weather.forecast" :key="row.day">
                <td>{{ row.day }}</td>
                <td>{{ row.temp_avg_c ?? '‚Äî' }}</td>
                <td>{{ row.wind_max_ms }}</td>
                <td>{{ row.rain_mm }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Air table (unchanged) -->
        <div>
          <h3>Air Quality (next 3 days)</h3>
          <table v-if="air?.forecast?.length">
            <thead>
              <tr><th>Day</th><th>AQI (max)</th><th>Alerts</th></tr>
            </thead>
            <tbody>
              <tr v-for="d in air.forecast" :key="d.day">
                <td>{{ d.day }}</td>
                <td><span class="aqi" :class="aqiClass(d.aqi_max)">{{ aqiLabel(d.aqi_max) }}</span></td>
                <td>
                  <span v-if="!d.alerts || d.alerts.length === 0" class="badge ok">Good</span>
                  <span v-else class="chip" v-for="a in d.alerts" :key="a.pollutant">
                    {{ a.pollutant }}: {{ a.value_max }} (good ‚â§ {{ a.good_max }})
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3>Packing Assistant (AI)</h3>
        <div class="row">
          <button @click="getPack" :disabled="loadingPack">Generate checklist</button>
          <span v-if="loadingPack" class="spinner" aria-label="Loading"></span>
        </div>
        <div v-if="packError" class="errorBox" style="margin-top:8px;">
          {{ packError }}
        </div>
        <div v-if="pack">
          <ul class="list">
            <li v-for="(item,i) in pack.checklist" :key="i">{{ item }}</li>
          </ul>
          <p class="muted" style="margin-top:8px">{{ pack.notes }}</p>
        </div>
      </div>

    </template>

    <div class="divider"></div>
    <footer>Built By- Ayushmaan Kumar Yadav(22300162) </footer>
  </div>
</div>

<script>
const { createApp, ref, onMounted, computed } = Vue;

createApp({
  setup() {
    // Start on home screen
    const view = ref("home");

    // existing state
    
    // Start with an empty input on the home screen
    const paramsCity = new URLSearchParams(location.search).get("city");
    const lastCity = localStorage.getItem("lastCity");
    const city = ref(paramsCity || "");

    const loading = ref(false);
    const error = ref("");
    const weather = ref(null);  // from /api/weather3
    const air = ref(null);      // from /api/air3
    const cityInput = ref(null);
    const suggestions = ref([]);
    const showDropdown = ref(false);
    const highlighted = ref(-1);
    let debounceTimer;
    const pack = ref(null);
    const loadingPack = ref(false);
    const packError = ref("");

    async function getPack() {
      const q = city.value.trim();
      if (!q) { packError.value = "Enter a city first."; return; }
      packError.value = ""; loadingPack.value = true; pack.value = null;
      try {
        const r = await fetch(`/api/pack?city=${encodeURIComponent(q)}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || "LLM error");
        pack.value = j;
      } catch (e) {
        packError.value = e.message || "Failed to generate checklist.";
      } finally {
        loadingPack.value = false;
      }
    }

    
// debounce helper
    function debounce(fn, delay) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fn, delay);
    }
    function onCityInput() {
      const q = city.value.trim();
      if (q.length < 2) {
        suggestions.value = [];
        showDropdown.value = false;
        return;
      }

      debounce(async () => {
        try {
          const res = await fetch(`/api/cities?q=${encodeURIComponent(q)}`);
          if (!res.ok) throw new Error();
          suggestions.value = await res.json();
          showDropdown.value = suggestions.value.length > 0;
          highlighted.value = -1;
        } catch {
          suggestions.value = [];
          showDropdown.value = false;
        }
      }, 200);
    }

    function showSuggestions() {
      if (suggestions.value.length) showDropdown.value = true;
    }
    function hideSuggestions() {
      setTimeout(() => showDropdown.value = false, 150);
    }

    function highlightNext(delta) {
      if (!suggestions.value.length) return;
      const n = suggestions.value.length;
      highlighted.value = (highlighted.value + delta + n) % n;
    }

    function confirmSelection() {
      if (highlighted.value >= 0 && highlighted.value < suggestions.value.length) {
        pickCity(suggestions.value[highlighted.value]);
      } else {
        run();
      }
    }

    function pickCity(s) {
      city.value = s.label;
      showDropdown.value = false;
      run();
    }



    // recently searched
    const recent = ref(JSON.parse(localStorage.getItem("recentCities") || "[]"));

    const todayAQI = computed(() => air.value?.forecast?.[0]?.aqi_max ?? null);

    function aqiLabel(a) {
      if (a == null) return "‚Äî";
      return a === 1 ? "Good" : a === 2 ? "Fair" : a === 3 ? "Moderate" : a === 4 ? "Poor" : "Very Poor";
    }
    function aqiClass(a) {
      if (a == null) return "";
      return a <= 2 ? "good" : a === 3 ? "moderate" : "unhealthy";
    }

    function rememberCity(name) {
      if (!name) return;
      const list = [name, ...recent.value.filter(c => c.toLowerCase() !== name.toLowerCase())].slice(0, 6);
      recent.value = list;
      localStorage.setItem("recentCities", JSON.stringify(list));
    }

    async function run() {
      const q = city.value.trim();
      if (!q) { error.value = "Please enter a city."; weather.value = air.value = null; return; }
      loading.value = true; error.value = ""; weather.value = air.value = null;
      pack.value = null;        // Clear old AI checklist
      packError.value = "";

      localStorage.setItem("lastCity", q);
      rememberCity(q);

      const u = new URL(location.href);
      u.searchParams.set("city", q);
      history.replaceState({}, "", u);

      try {
        const [w, a] = await Promise.all([
          fetch(`/api/weather3?city=${encodeURIComponent(q)}`).then(r => r.ok ? r.json() : r.json().then(j => {throw new Error(j.error || "Weather error")})),
          fetch(`/api/air3?city=${encodeURIComponent(q)}`).then(r => r.ok ? r.json() : r.json().then(j => {throw new Error(j.error || "Air error")}))
        ]);
        weather.value = w;
        air.value = a;
        view.value = "dashboard"; // switch to dashboard once loaded
      } catch (e) {
        error.value = e.message || "Unknown error";
      } finally {
        loading.value = false;
      }
    }

    function quick(cityName) {
      city.value = cityName;
      run();
    }

    function goHome() {
      view.value = "home";
      error.value = "";

      //clear input fields
      city.value = "";
      weather.value = null;
      air.value = null;

      //remove the city param from URL
      const u = new URL(location.href);
      u.searchParams.delete("city");
      history.replaceState({}, "", u.pathname);

      requestAnimationFrame(() => cityInput.value.focus()); 
    }

    onMounted(() => {
      if (cityInput.value) cityInput.value.focus();
      const hasCityInUrl = !!new URLSearchParams(location.search).get("city");
      if (hasCityInUrl) run();
    });

    return { view, city, loading, error, weather, air, run, quick, goHome, cityInput, recent, aqiLabel, aqiClass, todayAQI,
      suggestions, showDropdown, highlighted, onCityInput, highlightNext, confirmSelection,showSuggestions, hideSuggestions, pickCity,
      pack, loadingPack, packError, getPack
     };
  }
}).mount("#app");
</script>
</body>
</html>